name: Build & Deploy AFC 11ty Site + PHP

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - article
      - caseStudy
      - service
      - client
      - event
      - review
      - singleton
  push:
    branches:
      - main
    paths:
      - "web/**"
      - "mailhandler.php"
      - "composer.json"
      - "composer.lock"
      - ".github/workflows/build-prod.yml"

jobs:
  build:
    name: Build 11ty site and PHP deps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Project Dependencies (11ty)
        run: npm ci --legacy-peer-deps
        working-directory: web

      - name: Build 11ty static site
        env:
          NODE_ENV: production
          ELEVENTY_ENVIRONMENT: production
        run: |
          export NODE_OPTIONS="--max-old-space-size=2048"
          npx @11ty/eleventy
        working-directory: web
      
      - name: Verify 11ty build
        run: ls -la web/_site

      - name: Copy mailhandler.php into _site
        run: cp web/mailhandler.php web/_site/

      - name: Setup PHP with Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer
          coverage: none

      - name: Install PHP dependencies into _site
        run: |
          # copy composer metadata into the build output
          cp web/composer.* web/_site/
          cd web/_site
          composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Package site for deploy
        run: |
          # Tar the contents of web/_site, not the directory name itself
          tar czf afc-site.tar.gz -C web/_site .

      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: afc-site-artifact
          path: afc-site.tar.gz

  deploy:
    name: Deploy to andyfitzgeraldconsulting.com
    runs-on: ubuntu-latest
    needs: build

    env:
      AFC_RECAPTCHA_SECRET: ${{ secrets.RECAPTCHA_SECRET }}
      AFC_GMAIL_FROM: ${{ secrets.GMAIL_FROM }}
      AFC_GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      AFC_GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      AFC_GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}

    steps:
      - name: Download deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: afc-site-artifact

      - name: Copy tarball to droplet
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AFC_HOST }} 
          username: ${{ secrets.AFC_SSH_USER }} 
          key: ${{ secrets.AFC_SSH_KEY }}
          port: 22
          source: "afc-site.tar.gz"
          target: "/tmp"

      - name: Deploy on droplet (atomic)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.AFC_HOST }}
          username: ${{ secrets.AFC_SSH_USER }}
          key: ${{ secrets.AFC_SSH_KEY }}
          port: 22
          envs: AFC_RECAPTCHA_SECRET,AFC_GMAIL_FROM,AFC_GOOGLE_CLIENT_ID,AFC_GOOGLE_CLIENT_SECRET,AFC_GOOGLE_REFRESH_TOKEN
          script: |
            set -e

            BASE="/var/www/afc"
            RELEASES="$BASE/releases"
            CURRENT="$BASE/html"

            mkdir -p "$RELEASES"

            TS="$(date +%Y%m%d%H%M%S)"
            NEW_RELEASE="$RELEASES/$TS"

            echo ">>> Creating new release at $NEW_RELEASE"
            mkdir "$NEW_RELEASE"

            echo ">>> Extracting tarball into new release..."
            tar xzf /tmp/afc-site.tar.gz -C "$NEW_RELEASE"

            echo ">>> Writing fresh .env from GitHub Secrets..."
            # Start with an empty file
            : > "$NEW_RELEASE/.env"

            # Append each env line explicitly (no heredoc, no indentation issues)
            {
              printf 'RECAPTCHA_SECRET=%s\n' "$AFC_RECAPTCHA_SECRET"
              printf 'GMAIL_FROM=%s\n' "$AFC_GMAIL_FROM"
              printf 'GOOGLE_CLIENT_ID=%s\n' "$AFC_GOOGLE_CLIENT_ID"
              printf 'GOOGLE_CLIENT_SECRET=%s\n' "$AFC_GOOGLE_CLIENT_SECRET"
              printf 'GOOGLE_REFRESH_TOKEN=%s\n' "$AFC_GOOGLE_REFRESH_TOKEN"
            } >> "$NEW_RELEASE/.env"

            # Permissions so PHP-FPM (www-data) can read .env
            chmod 644 "$NEW_RELEASE/.env"

            echo ">>> Updating html symlink..."
            ln -sfn "$NEW_RELEASE" "$CURRENT"

            echo ">>> Cleaning up old releases (keep 5 most recent)..."
            cd "$RELEASES"
            ls -1t | tail -n +4 | xargs -r rm -rf

            echo ">>> Deployment complete."
